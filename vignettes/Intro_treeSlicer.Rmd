---
title: "Introduction to treeSlicer"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

# Introduction

**treesliceR** is an R package that provides tools to flexibly subset and slice phylogenetic trees at different depths and ways, and also use these sliced/subset trees in downstream analysis (e.g. to assess phylogenetic patterns like beta and alpha phylogenetic metrics). Using {`treesliceR`}, users can slice phylogenies in any temporal orientation (“rootwardly” or “tipwardly”) using different temporal criteria (million years or accumulated phylogenetic diversity). 

Moreover, {`treesliceR`} contain functions to assess the rates of accumulation of phylogenetic information (e.g., “α” and “β” diversities) through time. All the analysis are designed to be flexible, reliable and fast, since functions that are computationally time-demanding were designed to run under parallel computation. Finally, our package also provides plotting functions that allows to produce ready-to-use figures.

In order to illustrate the basic use of treesliceR we will present some examples on how to subset and slice phylogenies in different ways. To do that we will need the following packages:

```{r echo=TRUE, eval=FALSE}
libs <- c("ape", "ggtree", "ggplot2", "cowplot")

# Checking if they're installed
if (!requireNamespace(libs, quietly = TRUE)){
    install.packages(libs)
}

# Loading them
library(ape)
devtools::load_all() # library(treesliceR) here
```

# Subsetting and slicing phylogenies

treeSlicer provides a set of functions that can be used to slice phylogenetic trees in alternative ways. Slicing phylogenies can be used for different tasks, from vizualization purposes to conduct downstream analysis (for some examples see the main study and some other studies).

For this purpose we will use a phylogenetic tree of passarine species (308 species) presented in the package. The object pass_tree comprises a multiphylo object with 100 phylogenetic trees. For the sake of simplicity we will use only one tree. To load this dataset use the following code.

```{r readData, echo=TRUE, eval=FALSE}
library(treesliceR)
data("pass_trees")
tree <- pass_trees[[1]]
```

# Prunning function

treesliceR has functions that allow to prune a phylogenetic tree based on a specific absolute tree depth or by setting a quantile based on the age distribution of sppliting events in the phylogenetic tree. In both procedures (absolute age or quantile), all tips that have the age of the last splitting event **after** the value specified in the time argument will be pruned off the phylogeny. For example, lets prune the phylogeny in a way to keep only lineages that have sppliting events older than 10 and 30 million years.

```{r echo=TRUE, eval=FALSE}
tree_pruned10 <- prune_tips(tree = tree, time = 10, qtl = F)
tree_pruned30 <- prune_tips(tree = tree, time = 30, qtl = F)
```

Lets check the format of those trees

```{r}
par(mfrow = c(1, 3)) # Setting an 1x3 graphical display
plot(tree, main = "All species", show.tip.label = F); axisPhylo()
plot(tree_pruned10, main = "Species older than 10my", show.tip.label = F); axisPhylo()
plot(tree_pruned30, main = "Species older than 30my", show.tip.label = T); axisPhylo()
```
We can see that only species in which the last sppliting event are greater than 10 and 30 million years are kept in the trees. It is worth to note that the original branch lengths are not changed. From the left to the right we have the original phylogeny, the phylogeny containing only species in which the last sppliting event were older than 10 myr and, finally, the phylogeny with species that the last branching event was older than 30 myr (only three species in this case)

The same procedure can be done by setting the `time` argument as a scalar indicating the quantile of the distribution of species ages (given by the time from the last branching event and the present). For example, if we want to keep only the species with age values younger (lower) than the ages of 25th quantile of the age distribution of all species, we can do the following:

```{r}
tree_pruned25q <- prune_tips(tree, 0.25, qtl = T, method = 2)
plot(tree_pruned25q, main = "Species with ages younger than 25th quantile", show.tip.label = F); axisPhylo()
```

Note that if we want to keep the species we set the `method` argument as 2. The default value is 1, i.e., we remove the tips with ages younger than the threshold specified in `time` argument.

# Slicing functions

The second family of functions present in {`treesliceR`} allows to slice the phylogeny in different ways. In this section we will show the flexibility of tressliceR to perform tree slicing and vizualize the output of these functions. 


## Slicing from tip to roots

The first option to slice phylogenies is by squeezing its branch lengths from the tips to the root using the function `squeeze_int`. By squeezing we mean collapsing the branch lengths accordingly to a given threshold. In this function we need to provide a phylogenetic tree and a numeric value indicating the depth in which the branches will be squeezed. For example, let's squeeze the passerine phylogeny pruned at 10myr at three different ages: 10, 30 and 50 million years (myr).

```{r squeezeTip, echo=TRUE, eval=FALSE}

tree_squeeze10 <- squeeze_tips(tree = tree, time = 10, criteria = "my", dropNodes = FALSE)
tree_squeeze10_drop <- squeeze_tips(tree = tree, time = 10, criteria = "my", dropNodes = TRUE)

```

We can plot the phylogeny before and after the squeezing process to check out the difference

```{r plotSqueeze, echo=TRUE, eval=FALSE}

par(mfrow = c(1, 3)) # Setting an 1x3 graphical display
plot(tree, main = "Original tree", show.tip.label = F); axisPhylo()
plot(tree_squeeze10, main = "Tree squeezed at 10myr", show.tip.label = F); axisPhylo()
plot(tree_squeeze10_drop, main = "Tree squeezed at 10myr - drop nodes", show.tip.label = F); axisPhylo()
```

It is worth to note that when we set the argument `dropNodes` as TRUE we change the structure of the tree by removing the nodes from the original tree.


As mentioned before, we can squeeze the tree using diffent depths. Let's try it out with 30 and 50 myr and plot all trees to check the differences.

```{r plotSqueeze2, echo=TRUE, eval=FALSE}
tree_squeeze30 <- squeeze_tips(tree = tree, time = 30, criteria = "my", dropNodes = FALSE)
tree_squeeze50 <- squeeze_tips(tree = tree, time = 50, criteria = "my", dropNodes = FALSE)

```

## Slicing from root to tip

Another option implemented in treeSlicer is the function `squeeze_root`, in which the user can squeeze the phylogenetic tree from the root to the tips using the same depth criteria in myr of pd

```{r squeezeRoot, echo=TRUE, eval=FALSE}
tree_root50 <- squeeze_root(tree = tree, time = 50, criteria = "my")


```



