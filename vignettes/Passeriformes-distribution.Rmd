---
title: "Passerines Distribution"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Passerines Distribution}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

This article aims to map the species richness distributions of older and young lineages of Australian passerines. Moreover, using the `treesliceR` tools, we'll compare the distribution between these lineages and explore emergent patterns in space.

Before starting our analysis, we'll need to load the `ape`, `ggplot2`, and `ggpubr` packages. Additionally, if required, install the `devtools` to invoke the `treesliceR` package:
```{r, message = FALSE, warning = FALSE}
# Creating a list of our desired packages
libs <- c("ape", "devtools", "ggplot2", "ggpubr")

# Checking if they're installed
if (!requireNamespace(libs, quietly = TRUE)){
    install.packages(libs)
}

# Loading them
library(ape)
library(ggplot2)
library(ggpubr)
```

Now, we'll need to load (and install if necessary) the `treesliceR` package:
```{r, message = FALSE, warning = FALSE}
# Is it already present within the machine?
if (!requireNamespace("treesliceR", quietly = TRUE)){
    devtools::install_github("AraujoMat/treesliceR")
}

# Loading it
library(treesliceR)
```

# 1. Pruning the passerines phylogeny

Before conducting our analysis, it is necessary to load the passerines' phylogeny. We will invoke the `pass_trees` object, which is accessible within the `treesliceR` package. This object comprises 100 passerine phylogenies, but for this vignette we will use only the first one:
```{r}
tree <- pass_trees[[1]]
```

To evaluate the species richness distribution of both older and younger lineages, it is essential to segregate these lineages based on a specific criterion. Therefore, we will categorize lineages as older species if their last branching events are higher than the 75th quantile of the overall passerines age. This can be accomplished using the `prune_tips()` function:
```{r}
older <- prune_tips(tree, 0.75, qtl = T)
```


Now, we will classify lineages as younger if their ages are smaller than the 25th quantile of the overall passerine ages. However, because we aim to retain in the phylogeny those species originating *after* our quantile threshold, we will set the argument `method = 2` (for more details, see `?prune_tips()`):
```{r}
younger <- prune_tips(tree, 0.25, qtl = T, method = 2)
```

Let's visualize both our original and pruned phylogenies:
```{r}
par(mfrow = c(1, 3)) # Setting an 1x3 graphical display
plot(older, main = "All species", show.tip.label = F); axisPhylo()
plot(older, main = "Older species", show.tip.label = F); axisPhylo()
plot(younger, main = "Younger species", show.tip.label = F); axisPhylo()
par(mfrow = c(1, 1)) # Returning to 1x1
```


# 2. Distribution of species richness (older *vs* younger)

Before calculating the species richness distribution for our categories, we need to identify the older and younger species present in our pruned phylogenies:
```{r}
older <- older$tip.label
younger <- younger$tip.label
```

Now, we need to evaluate the distribution of these species. To do this, we'll load the passerines species matrix stored in the `pass_mat` object. Let's take a look at the first tree species in the matrix:
```{r}
head(pass_mat[, 1:3])
```

Then, we can create subsets of this matrix for both older and younger species. Let's begin with the older ones:
```{r}
positions <- which(colnames(pass_mat) %in% older)
old_mat <- pass_mat[, positions]
```

Now, let's proceed with creating subsets for the younger species:
```{r}
positions <- which(colnames(pass_mat) %in% younger)
yng_mat <- pass_mat[, positions]
```

Now, we can load a grid map of Australia and incorporate all this species richness information onto it:
```{r}
grid <- AU_grid
grid$SR_old <- rowSums(old_mat)
grid$SR_yng <- rowSums(yng_mat)
```

Then, visualize the species richness patterns for both categories:
```{r}
# Younger
AU_yng <- ggplot() +
          geom_sf(data = grid, aes(fill = SR_yng)) +
          scale_fill_gradient(low = "white", high = "red") +          
          labs(fill = "SR (Young)") +
          theme_void()
# Older
AU_old <- ggplot() +
          geom_sf(data = grid, aes(fill = SR_old)) +
          scale_fill_gradient(low = "white", high = "red") +
          labs(fill = "SR (Old)") +
          theme_void()
# Plotting
ggarrange(AU_yng, AU_old, labels = c("a)", "b)"), ncol = 2, nrow = 1)
```


# 3. Mismatches in species richness distribution

As observed above, there is a noticeable correspondence between the species richness of younger and older lineages. However, the extent of is this relationship is uncertain. Let's fit a simple linear regression to quantify this relationship:
```{r}
model <- lm(SR_yng ~ SR_old, data = grid)
```

Now, let's examine the summarized results:
```{r}
summary(model)
```

Note that its coefficient of determination is significantly and higher (R² = 63%!!!!). Thus, areas with high richness of younger lineages will generally also exhibit high richness of older lineages. These areas could indicate different dynamics of diversification rates over time, concurrently influencing the patterns of species richness of lineages of different depths.

However, let's examine a scatterplot depicting the species richness of both categories:
```{r}
plot(SR_yng ~ SR_old, data = grid,
     ylab = "Species richness (younger)",
     xlab = "Species richness (older)")
# Regression line
abline(model, col = "red")
```

Despite the stronger relationship between the species richness of both, the deviations in these patterns could indicate important and unidentified biogeographical processes influencing the currently observed species richness of these lineages.

Therefore, let's capture the deviations of our model using the `residuals` function and visualize them on the Australia map:
```{r}
grid$res <- residuals(model)
# Mapping it
ggplot() + 
  geom_sf(data = grid, aes(fill = res)) +
  scale_fill_gradient2(low = "red", mid = "grey80", high = "blue") +
  labs(fill = "Residuals") +
  theme_void()
```

Areas in blue indicate a higher predominance of younger lineages than expected, while in red those older lineages predominate. Areas colored in grey indicate that the observed species richness of younger and older species matches the richness expected by our model.

Using these residuals, we can attempt to infer the processes leading to the differences between the species richness of older and younger lineages. Interestingly, these differences observed in the residuals are highly structured in space. On the one hand, there is a higher predominance of older lineages within deserts, which could be attributed to a processes of lower diversification rates within these locations over time. On the other hand, younger lineages predominate in humid areas and islands, indicating locations where diversification rates are higher and continually generate recent lineages. However, both mechanisms mentioned here remain in the realm of hypothesis and are open to further empirical testing.

That’s all folks!

# Related research
Hawkins, B. A., Diniz‐Filho, J. A. F., Jaramillo, C. A, and Soeller, S. A. 2007. Climate, Niche Conservatism, and the Global Bird Diversity Gradient. - The American Naturalist 170(S2): S16–S27. https://doi.org/10.1086/519009

Sonne, J., Dalsgaard, B., Borregaard, M. K., Kennedy, J., Fjeldså, J. and Rahbek, C. 2022. Biodiversity cradles and museums segregating within hotspots of endemism. - Proceedings of Royal Society: B. 289: 20221102. https://doi.org/10.1098/rspb.2022.1102
